<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü - –ì–∞–∑–ø—Ä–æ–º –≥–∞–∑–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –£—Ñ–∞</title>
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        .table-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .table-box {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .table-box h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .table-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 1rem;
            overflow-x: auto;
        }
        
        .table-controls {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .table-controls button, .table-controls select, .table-controls input {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .table-controls button:hover {
            background-color: var(--secondary-color);
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        .settings-panel {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        
        .settings-group {
            margin-bottom: 1rem;
        }
        
        .settings-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .form-group {
            flex: 1;
        }
        
        .download-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .file-info {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .summary-panel {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f0f8ff;
            border-radius: 4px;
        }
        
        .summary-item {
            margin-bottom: 0.5rem;
        }
        
        .summary-item strong {
            display: inline-block;
            min-width: 150px;
        }
        
        #dataTable {
            width: 100% !important;
        }
        
        .dataTables_filter input {
            border: 1px solid #ddd !important;
            padding: 0.25rem !important;
        }
        
        .dataTables_length select {
            border: 1px solid #ddd !important;
            padding: 0.25rem !important;
        }
        
        .filter-panel {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #fffaf0;
            border-radius: 4px;
            display: none;
        }
        
        .sort-panel {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f0fff0;
            border-radius: 4px;
            display: none;
        }
        
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–∞ */
        .logo-img {
            height: 50px;
            width: auto;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-container">
                <div class="logo">
                    <img src="https://pic.rutubelist.ru/user/57/68/5768dcac4aeef5099dfbb01395851338.jpg" alt="–ì–∞–∑–ø—Ä–æ–º –≥–∞–∑–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –£—Ñ–∞" class="logo-img">
                    <div class="logo-text">
                        <span class="logo-title">–ì–∞–∑–ø—Ä–æ–º –≥–∞–∑–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –£—Ñ–∞</span>
                        <span class="logo-subtitle">–ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü</span>
                    </div>
                </div>
                
                <nav class="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item"><a href="../index.html" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li class="nav-item"><a href="../office-tools/index.html" class="nav-link">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</a></li>
                        <li class="nav-item"><a href="../trainers/index.html" class="nav-link">–¢—Ä–µ–Ω–∞–∂—ë—Ä—ã</a></li>
                        <li class="nav-item"><a href="index.html" class="nav-link active">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a></li>
                        <li class="nav-item"><a href="../ai-assistant/index.html" class="nav-link">–ü–æ–º–æ—â–Ω–∏–∫</a></li>
                    </ul>
                </nav>
                
                <button class="mobile-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main class="main">
        <section class="section-header">
            <div class="container">
                <h1 class="section-title">–ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h1>
                <p class="section-subtitle">–ú–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</p>
            </div>
        </section>

        <div class="container">
            <div class="table-container">
                <div class="table-box">
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞</h3>
                    
                    <div class="upload-area" id="uploadArea">
                        <p><i class="fas fa-cloud-upload-alt"></i> –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ CSV –∏–ª–∏ Excel —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏</p>
                        <button class="btn btn-outline" id="selectFileBtn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                        <div class="file-info" id="fileInfo">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                    </div>
                    
                    <div class="table-controls">
                        <button id="addColumnBtn"><i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü</button>
                        <button id="removeColumnBtn" disabled><i class="fas fa-minus"></i> –£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü</button>
                        <button id="filterBtn"><i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
                        <button id="sortBtn"><i class="fas fa-sort"></i> –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button id="calculateBtn"><i class="fas fa-calculator"></i> –í—ã—á–∏—Å–ª–∏—Ç—å</button>
                    </div>
                    
                    <div class="filter-panel" id="filterPanel">
                        <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filterColumn">–°—Ç–æ–ª–±–µ—Ü:</label>
                                <select id="filterColumn"></select>
                            </div>
                            <div class="form-group">
                                <label for="filterOperator">–û–ø–µ—Ä–∞—Ç–æ—Ä:</label>
                                <select id="filterOperator">
                                    <option value="=">–†–∞–≤–Ω–æ</option>
                                    <option value="!=">–ù–µ —Ä–∞–≤–Ω–æ</option>
                                    <option value=">">–ë–æ–ª—å—à–µ</option>
                                    <option value="<">–ú–µ–Ω—å—à–µ</option>
                                    <option value=">=">–ë–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ</option>
                                    <option value="<=">–ú–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ</option>
                                    <option value="contains">–°–æ–¥–µ—Ä–∂–∏—Ç</option>
                                    <option value="startsWith">–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å</option>
                                    <option value="endsWith">–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filterValue">–ó–Ω–∞—á–µ–Ω–∏–µ:</label>
                                <input type="text" id="filterValue" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏">
                            </div>
                        </div>
                        <button id="applyFilterBtn"><i class="fas fa-check"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                        <button id="clearFilterBtn"><i class="fas fa-times"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                    </div>
                    
                    <div class="sort-panel" id="sortPanel">
                        <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sortColumn">–°—Ç–æ–ª–±–µ—Ü:</label>
                                <select id="sortColumn"></select>
                            </div>
                            <div class="form-group">
                                <label for="sortDirection">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</label>
                                <select id="sortDirection">
                                    <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                                    <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                                </select>
                            </div>
                        </div>
                        <button id="applySortBtn"><i class="fas fa-check"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É</button>
                    </div>
                    
                    <div class="table-wrapper">
                        <table id="dataTable" class="display nowrap" style="width:100%"></table>
                    </div>
                    
                    <div class="summary-panel">
                        <h4>–°–≤–æ–¥–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º</h4>
                        <div id="dataSummary"></div>
                    </div>
                    
                    <div class="download-buttons">
                        <button id="exportExcelBtn"><i class="fas fa-file-excel"></i> –°–∫–∞—á–∞—Ç—å Excel</button>
                        <button id="exportCsvBtn"><i class="fas fa-file-csv"></i> –°–∫–∞—á–∞—Ç—å CSV</button>
                        <button id="exportPdfBtn"><i class="fas fa-file-pdf"></i> –°–∫–∞—á–∞—Ç—å PDF</button>
                    </div>
                    
                    <div class="settings-panel">
                        <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pageLength">–°—Ç—Ä–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                                <select id="pageLength">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="-1">–í—Å–µ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="showSearch" checked> 
                                    –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–∏—Å–∫
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="showInfo" checked> 
                                    –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-container">
                <div class="footer-column">
                    <h4 class="footer-title">–ü–ê–û ¬´–ì–∞–∑–ø—Ä–æ–º –≥–∞–∑–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –£—Ñ–∞¬ª</h4>
                    <p class="footer-text">–ö—Ä—É–ø–Ω–µ–π—à–∞—è –≥–∞–∑–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∞—è –Ω–∞–¥–µ–∂–Ω–æ–µ –≥–∞–∑–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞.</p>
                </div>
                
                <div class="footer-column">
                    <h4 class="footer-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</h4>
                    <ul class="footer-links">
                        <li><a href="../index.html" class="footer-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li><a href="../office-tools/index.html" class="footer-link">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</a></li>
                        <li><a href="../trainers/index.html" class="footer-link">–¢—Ä–µ–Ω–∞–∂—ë—Ä—ã</a></li>
                        <li><a href="index.html" class="footer-link">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a></li>
                        <li><a href="../ai-assistant/index.html" class="footer-link">–ü–æ–º–æ—â–Ω–∏–∫</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h4 class="footer-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                    <ul class="footer-contacts">
                        <li class="contact-item">
                            <span class="contact-icon">üìû</span>
                            <span>8-800-234-05-00</span>
                        </li>
                        <li class="contact-item">
                            <span class="contact-icon">‚úâÔ∏è</span>
                            <span>info@bashgaz.ru</span>
                        </li>
                        <li class="contact-item">
                            <span class="contact-icon">üìç</span>
                            <span>–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω, –≥. –£—Ñ–∞, —É–ª. –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è, –¥. 2, –∫–æ—Ä–ø. 4</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>¬© 2025 –ü–ê–û ¬´–ì–∞–∑–ø—Ä–æ–º –≥–∞–∑–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –£—Ñ–∞¬ª. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
                <div class="footer-links">
                    <a href="https://www.bashgaz.ru/upload/–ü–æ–ª–∏—Ç–∏–∫–∞%20–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏.pdf" class="footer-link">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                    <a href="https://www.bashgaz.ru/upload/user_agreement.pdf" class="footer-link">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let dataTable;
        let currentData = [];
        let currentColumns = [];
        let currentFileName = '';
        let filteredData = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeDataTable();
            setupEventListeners();
        });
        
        function initializeDataTable() {
            dataTable = $('#dataTable').DataTable({
                dom: 'Bfrtip',
                buttons: [],
                scrollX: true,
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/ru.json'
                }
            });
        }
        
        function setupEventListeners() {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const selectFileBtn = document.getElementById('selectFileBtn');
            
            selectFileBtn.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary-color)';
                uploadArea.style.backgroundColor = 'var(--primary-light)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.backgroundColor = 'transparent';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.backgroundColor = 'transparent';
                
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    handleFileUpload(fileInput.files[0]);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('addColumnBtn').addEventListener('click', addCalculatedColumn);
            document.getElementById('removeColumnBtn').addEventListener('click', removeSelectedColumn);
            document.getElementById('filterBtn').addEventListener('click', toggleFilterPanel);
            document.getElementById('sortBtn').addEventListener('click', toggleSortPanel);
            document.getElementById('calculateBtn').addEventListener('click', showCalculations);
            
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
            document.getElementById('clearFilterBtn').addEventListener('click', clearFilter);
            document.getElementById('applySortBtn').addEventListener('click', applySort);
            
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('pageLength').addEventListener('change', function() {
                dataTable.page.len(this.value).draw();
            });
            
            document.getElementById('showSearch').addEventListener('change', function() {
                $('#dataTable_filter').toggle(this.checked);
            });
            
            document.getElementById('showInfo').addEventListener('change', function() {
                $('#dataTable_info').toggle(this.checked);
            });
        }
        
        function handleFileUpload(file) {
            currentFileName = file.name;
            document.getElementById('fileInfo').textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ${file.name}`;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = e.target.result;
                
                if (file.name.endsWith('.csv')) {
                    parseCSV(data);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    parseExcel(data);
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        function parseCSV(data) {
            Papa.parse(data, {
                header: true,
                complete: function(results) {
                    if (results.data.length > 0 && results.meta.fields) {
                        processParsedData(results.meta.fields, results.data);
                    } else {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.');
                    }
                },
                error: function(error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ CSV —Ñ–∞–π–ª–∞: ' + error.message);
                }
            });
        }
        
        function parseExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (jsonData.length > 1) {
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç, –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π CSV
                    const fields = headers;
                    const data = rows.map(row => {
                        const obj = {};
                        headers.forEach((header, i) => {
                            obj[header] = row[i] !== undefined ? row[i] : '';
                        });
                        return obj;
                    });
                    
                    processParsedData(fields, data);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: ' + error.message);
            }
        }
        
        function processParsedData(fields, data) {
            currentData = data;
            currentColumns = fields;
            filteredData = [...data];
            
            // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            dataTable.clear().destroy();
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏ –¥–ª—è DataTables
            const columns = fields.map(field => {
                return { 
                    title: field,
                    data: field
                };
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            dataTable = $('#dataTable').DataTable({
                data: filteredData,
                columns: columns,
                dom: 'Bfrtip',
                buttons: [],
                scrollX: true,
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/ru.json'
                },
                pageLength: document.getElementById('pageLength').value
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
            updateDataSummary(fields, filteredData);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            updateColumnSelects(fields);
            
            // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('removeColumnBtn').disabled = false;
        }
        
        function updateColumnSelects(fields) {
            const filterColumn = document.getElementById('filterColumn');
            const sortColumn = document.getElementById('sortColumn');
            
            filterColumn.innerHTML = '';
            sortColumn.innerHTML = '';
            
            fields.forEach(field => {
                filterColumn.innerHTML += `<option value="${field}">${field}</option>`;
                sortColumn.innerHTML += `<option value="${field}">${field}</option>`;
            });
        }
        
        function updateDataSummary(fields, data) {
            let summaryHtml = '';
            
            // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            summaryHtml += `
                <div class="summary-item"><strong>–ö–æ–ª–æ–Ω–æ–∫:</strong> ${fields.length}</div>
                <div class="summary-item"><strong>–°—Ç—Ä–æ–∫:</strong> ${data.length}</div>
            `;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–∏—Å–ª–æ–≤—ã–º –∫–æ–ª–æ–Ω–∫–∞–º
            const numericColumns = [];
            
            fields.forEach(field => {
                const sampleValue = data[0] ? data[0][field] : null;
                if (sampleValue && !isNaN(parseFloat(sampleValue))) {
                    numericColumns.push(field);
                }
            });
            
            if (numericColumns.length > 0) {
                summaryHtml += `<div class="summary-item"><strong>–ß–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏:</strong> ${numericColumns.join(', ')}</div>`;
                
                numericColumns.forEach(column => {
                    const values = data.map(row => parseFloat(row[column])).filter(val => !isNaN(val));
                    if (values.length > 0) {
                        const min = Math.min(...values);
                        const max = Math.max(...values);
                        const avg = values.reduce((a, b) => a + b, 0) / values.length;
                        const sum = values.reduce((a, b) => a + b, 0);
                        
                        summaryHtml += `
                            <div class="summary-item">
                                <strong>${column}:</strong>
                                min: ${min.toFixed(2)}, max: ${max.toFixed(2)}, avg: ${avg.toFixed(2)}, sum: ${sum.toFixed(2)}
                            </div>
                        `;
                    }
                });
            }
            
            document.getElementById('dataSummary').innerHTML = summaryHtml;
        }
        
        function addCalculatedColumn() {
            const columnName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏:');
            if (!columnName) return;
            
            const formula = prompt('–í–≤–µ–¥–∏—Ç–µ —Ñ–æ—Ä–º—É–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–ª–æ–Ω–∫–∞1 + –ö–æ–ª–æ–Ω–∫–∞2):');
            if (!formula) return;
            
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É
                currentColumns.push(columnName);
                
                // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
                currentData.forEach(row => {
                    try {
                        // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–µ–Ω –ø–∞—Ä—Å–µ—Ä —Ñ–æ—Ä–º—É–ª)
                        let computedValue = formula;
                        currentColumns.forEach(col => {
                            const value = row[col] || 0;
                            computedValue = computedValue.replace(new RegExp(col, 'g'), value);
                        });
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (–æ–ø–∞—Å–Ω–æ - –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π eval)
                        row[columnName] = eval(computedValue);
                    } catch (e) {
                        row[columnName] = '–û—à–∏–±–∫–∞';
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                processParsedData(currentColumns, currentData);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–ª–æ–Ω–∫–∏: ' + e.message);
            }
        }
        
        function removeSelectedColumn() {
            const columns = dataTable.columns().header().toArray();
            const columnNames = columns.map(col => col.textContent);
            
            const columnToRemove = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (${columnNames.join(', ')}):`);
            if (!columnToRemove || !columnNames.includes(columnToRemove)) {
                alert('–ö–æ–ª–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const columnIndex = columnNames.indexOf(columnToRemove);
            currentColumns.splice(columnIndex, 1);
            
            // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
            currentData.forEach(row => {
                delete row[columnToRemove];
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            processParsedData(currentColumns, currentData);
        }
        
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            document.getElementById('sortPanel').style.display = 'none';
        }
        
        function toggleSortPanel() {
            const panel = document.getElementById('sortPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            document.getElementById('filterPanel').style.display = 'none';
        }
        
        function applyFilter() {
            const column = document.getElementById('filterColumn').value;
            const operator = document.getElementById('filterOperator').value;
            const value = document.getElementById('filterValue').value;
            
            if (!column || !operator) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä');
                return;
            }
            
            try {
                filteredData = currentData.filter(row => {
                    const cellValue = row[column] !== undefined ? row[column].toString() : '';
                    const filterValue = value.toString();
                    
                    switch(operator) {
                        case '=': return cellValue === filterValue;
                        case '!=': return cellValue !== filterValue;
                        case '>': return parseFloat(cellValue) > parseFloat(filterValue);
                        case '<': return parseFloat(cellValue) < parseFloat(filterValue);
                        case '>=': return parseFloat(cellValue) >= parseFloat(filterValue);
                        case '<=': return parseFloat(cellValue) <= parseFloat(filterValue);
                        case 'contains': return cellValue.includes(filterValue);
                        case 'startsWith': return cellValue.startsWith(filterValue);
                        case 'endsWith': return cellValue.endsWith(filterValue);
                        default: return true;
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                dataTable.clear();
                dataTable.rows.add(filteredData);
                dataTable.draw();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
                updateDataSummary(currentColumns, filteredData);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                document.getElementById('filterPanel').style.display = 'none';
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: ' + e.message);
            }
        }
        
        function clearFilter() {
            filteredData = [...currentData];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            dataTable.clear();
            dataTable.rows.add(filteredData);
            dataTable.draw();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
            updateDataSummary(currentColumns, filteredData);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('filterPanel').style.display = 'none';
        }
        
        function applySort() {
            const column = document.getElementById('sortColumn').value;
            const direction = document.getElementById('sortDirection').value;
            
            if (!column) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏');
                return;
            }
            
            try {
                filteredData.sort((a, b) => {
                    const valA = a[column];
                    const valB = b[column];
                    
                    if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
                        return (parseFloat(valA) - parseFloat(valB)) * (direction === 'asc' ? 1 : -1);
                    } else {
                        return valA.toString().localeCompare(valB.toString()) * (direction === 'asc' ? 1 : -1);
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                dataTable.clear();
                dataTable.rows.add(filteredData);
                dataTable.draw();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                document.getElementById('sortPanel').style.display = 'none';
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ: ' + e.message);
            }
        }
        
        function showCalculations() {
            const numericColumns = [];
            
            currentColumns.forEach(field => {
                const sampleValue = currentData[0] ? currentData[0][field] : null;
                if (sampleValue && !isNaN(parseFloat(sampleValue))) {
                    numericColumns.push(field);
                }
            });
            
            if (numericColumns.length === 0) {
                alert('–ù–µ—Ç —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }
            
            const columnToAnalyze = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∏—Å–ª–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ (${numericColumns.join(', ')}):`);
            if (!columnToAnalyze || !numericColumns.includes(columnToAnalyze)) {
                alert('–ö–æ–ª–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–≤–æ–π');
                return;
            }
            
            const values = filteredData.map(row => parseFloat(row[columnToAnalyze])).filter(val => !isNaN(val));
            if (values.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }
            
            const sum = values.reduce((a, b) => a + b, 0);
            const avg = sum / values.length;
            const min = Math.min(...values);
            const max = Math.max(...values);
            const stdDev = Math.sqrt(values.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b) / values.length);
            
            alert(`
                –ê–Ω–∞–ª–∏–∑ –∫–æ–ª–æ–Ω–∫–∏ "${columnToAnalyze}":
                - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–µ–Ω–∏–π: ${values.length}
                - –°—É–º–º–∞: ${sum.toFixed(2)}
                - –°—Ä–µ–¥–Ω–µ–µ: ${avg.toFixed(2)}
                - –ú–∏–Ω–∏–º—É–º: ${min.toFixed(2)}
                - –ú–∞–∫—Å–∏–º—É–º: ${max.toFixed(2)}
                - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: ${stdDev.toFixed(2)}
            `);
        }
        
        function exportToExcel() {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É Excel
            const wb = XLSX.utils.book_new();
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–±–æ—á–∏–π –ª–∏—Å—Ç
            const ws = XLSX.utils.json_to_sheet(filteredData);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–±–æ—á–∏–π –ª–∏—Å—Ç –≤ –∫–Ω–∏–≥—É
            XLSX.utils.book_append_sheet(wb, ws, "–î–∞–Ω–Ω—ã–µ");
            
            // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            XLSX.writeFile(wb, currentFileName ? `${currentFileName.split('.')[0]}_export.xlsx` : 'data_export.xlsx');
        }
        
        function exportToCsv() {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ CSV
            const csv = Papa.unparse(filteredData);
            
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const dataStr = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute('href', dataStr);
            downloadAnchorNode.setAttribute('download', currentFileName ? `${currentFileName.split('.')[0]}_export.csv` : 'data_export.csv');
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        function exportToPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            doc.setFontSize(16);
            doc.text('–≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü—ã –¥–∞–Ω–Ω—ã—Ö', 105, 15, { align: 'center' });
            
            // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
            const columns = currentColumns.map(col => ({ header: col, dataKey: col }));
            const rows = filteredData.map(row => {
                const newRow = {};
                currentColumns.forEach(col => {
                    newRow[col] = row[col] !== undefined ? row[col].toString() : '';
                });
                return newRow;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            doc.autoTable({
                head: [currentColumns],
                body: rows.map(row => currentColumns.map(col => row[col])),
                startY: 25,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [51, 136, 255] }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º PDF
            doc.save(currentFileName ? `${currentFileName.split('.')[0]}_export.pdf` : 'data_export.pdf');
        }
    </script>
</body>
</html>