<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Геоаналитика - Газпром</title>
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .map-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .map-box {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .map-box h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .map-wrapper {
            position: relative;
            height: 600px;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        #map {
            height: 100%;
            width: 100%;
            border-radius: 4px;
            z-index: 1;
        }
        
        .map-controls {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .map-controls button, .map-controls select, .map-controls input {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .map-controls button:hover {
            background-color: var(--secondary-color);
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        .settings-panel {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        
        .settings-group {
            margin-bottom: 1rem;
        }
        
        .settings-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .color-picker input {
            width: 40px;
            height: 30px;
            padding: 0;
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .form-group {
            flex: 1;
        }
        
        .download-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .file-info {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .legend {
            padding: 6px 8px;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 1.5;
        }
        
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        
        .data-table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        
        .map-layer-control {
            background: white;
            padding: 5px;
            border-radius: 4px;
        }
        
        .column-options {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #f0f8ff;
            border-radius: 4px;
        }
        
        .column-option {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-container">
                <div class="logo">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Gazprom_logo.svg/1200px-Gazprom_logo.svg.png" alt="Газпром" class="logo-img">
                    <div class="logo-text">
                        <span class="logo-title">Газпром</span>
                        <span class="logo-subtitle">Геоаналитика</span>
                    </div>
                </div>
                
                <nav class="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item"><a href="../index.html" class="nav-link">Главная</a></li>
                        <li class="nav-item"><a href="../office-tools/index.html" class="nav-link">Инструменты</a></li>
                        <li class="nav-item"><a href="../trainers/index.html" class="nav-link">Тренажёры</a></li>
                        <li class="nav-item"><a href="index.html" class="nav-link">Аналитика</a></li>
                        <li class="nav-item"><a href="../ai-assistant/index.html" class="nav-link">Помощник</a></li>
                    </ul>
                </nav>
                
                <button class="mobile-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main class="main">
        <section class="section-header">
            <div class="container">
                <h1 class="section-title">Геоаналитика</h1>
                <p class="section-subtitle">Визуализация данных на карте с возможностью настройки</p>
            </div>
        </section>

        <div class="container">
            <div class="map-container">
                <div class="map-box">
                    <h3>Настройки карты</h3>
                    
                    <div class="upload-area" id="uploadArea">
                        <p><i class="fas fa-cloud-upload-alt"></i> Перетащите сюда CSV или Excel файл с геоданными или</p>
                        <button class="btn btn-outline" id="selectFileBtn">Выбрать файл</button>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                        <div class="file-info" id="fileInfo">Файл не выбран</div>
                        <p class="file-hint">Файл должен содержать столбцы с координатами (широта и долгота) и данными для визуализации</p>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="latitudeColumn">Столбец с широтой:</label>
                            <select id="latitudeColumn" disabled>
                                <option value="">Выберите столбец</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="longitudeColumn">Столбец с долготой:</label>
                            <select id="longitudeColumn" disabled>
                                <option value="">Выберите столбец</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataColumn">Столбец с данными:</label>
                            <select id="dataColumn" disabled>
                                <option value="">Выберите столбец</option>
                                <option value="none">Без данных (только точки)</option>
                                <option value="cluster">Кластеры точек</option>
                                <option value="heatmap">Тепловая карта</option>
                                <option value="circle">Круговые маркеры</option>
                                <option value="symbol">Символьная карта</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="columnOptions" class="column-options" style="display: none;">
                        <div class="column-option">
                            <label for="minRadius">Минимальный радиус:</label>
                            <input type="range" id="minRadius" min="1" max="20" value="5">
                            <span id="minRadiusValue">5</span>
                        </div>
                        <div class="column-option">
                            <label for="maxRadius">Максимальный радиус:</label>
                            <input type="range" id="maxRadius" min="10" max="50" value="20">
                            <span id="maxRadiusValue">20</span>
                        </div>
                        <div class="column-option">
                            <label for="colorScale">Цветовая шкала:</label>
                            <select id="colorScale">
                                <option value="red">Красная</option>
                                <option value="blue">Синяя</option>
                                <option value="green">Зеленая</option>
                                <option value="rainbow">Радужная</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="map-wrapper">
                        <div id="map"></div>
                    </div>
                    
                    <div class="map-controls">
                        <button id="addLayerBtn"><i class="fas fa-layer-group"></i> Добавить слой</button>
                        <button id="removeLayerBtn" disabled><i class="fas fa-trash"></i> Удалить слой</button>
                        <button id="fitBoundsBtn"><i class="fas fa-expand"></i> Подогнать область</button>
                        <button id="clearMapBtn"><i class="fas fa-broom"></i> Очистить карту</button>
                    </div>
                    
                    <div class="download-buttons">
                        <button id="exportImageBtn"><i class="fas fa-download"></i> Скачать как изображение</button>
                        <button id="exportDataBtn"><i class="fas fa-file-csv"></i> Скачать данные (GeoJSON)</button>
                        <button id="exportPdfBtn"><i class="fas fa-file-pdf"></i> Скачать отчет (PDF)</button>
                    </div>
                    
                    <div class="settings-panel">
                        <h4>Настройки отображения</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mapStyle">Стиль карты:</label>
                                <select id="mapStyle">
                                    <option value="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png">OpenStreetMap</option>
                                    <option value="https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png">OpenTopoMap</option>
                                    <option value="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}">Спутник</option>
                                    <option value="https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png">Темная</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mapZoom">Уровень масштабирования:</label>
                                <input type="range" id="mapZoom" min="1" max="18" value="5">
                            </div>
                        </div>
                    </div>
                    
                    <h3>Загруженные данные</h3>
                    <div class="data-table-container">
                        <table class="data-table" id="dataTable">
                            <thead id="headerRow"></thead>
                            <tbody id="tableData"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-container">
                <div class="footer-column">
                    <h4 class="footer-title">Газпром</h4>
                    <p class="footer-text">Крупнейшая газовая компания мира, лидер в области разведки, добычи, транспортировки, хранения, переработки и реализации углеводородов.</p>
                </div>
                
                <div class="footer-column">
                    <h4 class="footer-title">Навигация</h4>
                    <ul class="footer-links">
                        <li><a href="../index.html" class="footer-link">Главная</a></li>
                        <li><a href="../office-tools/index.html" class="footer-link">Инструменты</a></li>
                        <li><a href="../trainers/index.html" class="footer-link">Тренажёры</a></li>
                        <li><a href="index.html" class="footer-link">Аналитика</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h4 class="footer-title">Контакты</h4>
                    <ul class="footer-contacts">
                        <li class="contact-item">
                            <span class="contact-icon">📞</span>
                            <span>+7 (495) 719-30-01</span>
                        </li>
                        <li class="contact-item">
                            <span class="contact-icon">✉️</span>
                            <span>portal@gazprom.ru</span>
                        </li>
                        <li class="contact-item">
                            <span class="contact-icon">📍</span>
                            <span>Москва, ул. Наметкина, 16</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>© 2025 ПАО "Газпром". Все права защищены.</p>
                <div class="footer-links">
                    <a href="#" class="footer-link">Политика конфиденциальности</a>
                    <a href="#" class="footer-link">Условия использования</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Инициализация jsPDF
        const { jsPDF } = window.jspdf;
        
        let map;
        let currentLayer = null;
        let markersLayer = null;
        let heatmapLayer = null;
        let currentData = [];
        let currentFileName = '';
        let layersControl = null;
        let baseLayers = {};
        let overlayLayers = {};
        let currentLegend = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
        });
        
        function initializeMap() {
            map = L.map('map').setView([55.751244, 37.618423], 5); // Центр на Москве
            
            // Добавляем базовый слой
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            baseLayers = {
                "OpenStreetMap": osmLayer,
                "OpenTopoMap": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    maxZoom: 17,
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
                }),
                "Спутник": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                }),
                "Темная": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                })
            };
            
            layersControl = L.control.layers(baseLayers, overlayLayers, {
                collapsed: false,
                position: 'topright'
            }).addTo(map);
            
            // Добавляем масштаб
            L.control.scale({position: 'bottomleft'}).addTo(map);
            
            // Инициализируем слой для маркеров
            markersLayer = L.layerGroup().addTo(map);
            overlayLayers['Маркеры'] = markersLayer;
            
            // Инициализируем слой для тепловой карты
            heatmapLayer = L.layerGroup().addTo(map);
            overlayLayers['Тепловая карта'] = heatmapLayer;
            
            // Обновляем контроль слоев
            layersControl.addOverlay(markersLayer, 'Маркеры');
            layersControl.addOverlay(heatmapLayer, 'Тепловая карта');
        }
        
        function setupEventListeners() {
            // Обработка загрузки файлов
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const selectFileBtn = document.getElementById('selectFileBtn');
            
            selectFileBtn.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary-color)';
                uploadArea.style.backgroundColor = 'var(--primary-light)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.backgroundColor = 'transparent';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.backgroundColor = 'transparent';
                
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    handleFileUpload(fileInput.files[0]);
                }
            });
            
            // Обработка кнопок управления
            document.getElementById('addLayerBtn').addEventListener('click', addDataLayer);
            document.getElementById('removeLayerBtn').addEventListener('click', removeCurrentLayer);
            document.getElementById('fitBoundsBtn').addEventListener('click', fitMapToData);
            document.getElementById('clearMapBtn').addEventListener('click', clearMap);
            document.getElementById('exportImageBtn').addEventListener('click', exportMapAsImage);
            document.getElementById('exportDataBtn').addEventListener('click', exportDataAsGeoJSON);
            document.getElementById('exportPdfBtn').addEventListener('click', exportMapAsPDF);
            
            // Обработка изменений настроек
            document.getElementById('mapStyle').addEventListener('change', function() {
                const selectedStyle = this.value;
                Object.values(baseLayers).forEach(layer => map.removeLayer(layer));
                baseLayers[this.options[this.selectedIndex].text].addTo(map);
            });
            
            document.getElementById('mapZoom').addEventListener('input', function() {
                map.setZoom(parseInt(this.value));
            });
            
            document.getElementById('dataColumn').addEventListener('change', function() {
                const columnOptions = document.getElementById('columnOptions');
                if (this.value && this.value !== 'none' && this.value !== 'cluster') {
                    columnOptions.style.display = 'block';
                } else {
                    columnOptions.style.display = 'none';
                }
            });
            
            document.getElementById('minRadius').addEventListener('input', function() {
                document.getElementById('minRadiusValue').textContent = this.value;
            });
            
            document.getElementById('maxRadius').addEventListener('input', function() {
                document.getElementById('maxRadiusValue').textContent = this.value;
            });
            
            // Обновляем уровень масштаба при изменении на карте
            map.on('zoomend', function() {
                document.getElementById('mapZoom').value = map.getZoom();
            });
        }
        
        function handleFileUpload(file) {
            currentFileName = file.name;
            document.getElementById('fileInfo').textContent = `Загружен файл: ${file.name}`;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = e.target.result;
                
                if (file.name.endsWith('.csv')) {
                    parseCSV(data);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    parseExcel(data);
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        function parseCSV(data) {
            Papa.parse(data, {
                header: true,
                complete: function(results) {
                    if (results.data.length > 0 && results.meta.fields) {
                        processParsedData(results.meta.fields, results.data);
                    } else {
                        alert('Не удалось прочитать данные из CSV файла. Проверьте формат файла.');
                    }
                },
                error: function(error) {
                    alert('Ошибка при чтении CSV файла: ' + error.message);
                }
            });
        }
        
        function parseExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (jsonData.length > 1) {
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    // Преобразуем в формат, аналогичный CSV
                    const fields = headers;
                    const data = rows.map(row => {
                        const obj = {};
                        headers.forEach((header, i) => {
                            obj[header] = row[i] !== undefined ? row[i] : '';
                        });
                        return obj;
                    });
                    
                    processParsedData(fields, data);
                }
            } catch (error) {
                alert('Ошибка при чтении Excel файла: ' + error.message);
            }
        }
        
        function processParsedData(fields, data) {
            currentData = data;
            
            // Обновляем таблицу с данными
            updateDataTable(fields, data);
            
            // Обновляем выпадающие списки для выбора столбцов
            updateColumnSelects(fields);
            
            // Включаем кнопки управления
            document.getElementById('latitudeColumn').disabled = false;
            document.getElementById('longitudeColumn').disabled = false;
            document.getElementById('dataColumn').disabled = false;
        }
        
        function updateDataTable(fields, data) {
            const headerRow = document.getElementById('headerRow');
            const tableData = document.getElementById('tableData');
            
            // Очищаем таблицу
            headerRow.innerHTML = '';
            tableData.innerHTML = '';
            
            // Добавляем заголовки
            fields.forEach(field => {
                headerRow.innerHTML += `<th>${field}</th>`;
            });
            
            // Добавляем данные (первые 50 строк)
            const displayData = data.slice(0, 50);
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                fields.forEach(field => {
                    const value = row[field] !== undefined ? row[field] : '';
                    tr.innerHTML += `<td>${value}</td>`;
                });
                tableData.appendChild(tr);
            });
            
            if (data.length > 50) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="${fields.length}" style="text-align: center; font-style: italic;">... и еще ${data.length - 50} строк</td>`;
                tableData.appendChild(tr);
            }
        }
        
        function updateColumnSelects(fields) {
            const latitudeSelect = document.getElementById('latitudeColumn');
            const longitudeSelect = document.getElementById('longitudeColumn');
            const dataSelect = document.getElementById('dataColumn');
            
            // Очищаем выпадающие списки
            latitudeSelect.innerHTML = '<option value="">Выберите столбец</option>';
            longitudeSelect.innerHTML = '<option value="">Выберите столбец</option>';
            dataSelect.innerHTML = '<option value="">Выберите столбец</option>';
            
            // Добавляем опции для каждого поля
            fields.forEach(field => {
                latitudeSelect.innerHTML += `<option value="${field}">${field}</option>`;
                longitudeSelect.innerHTML += `<option value="${field}">${field}</option>`;
                dataSelect.innerHTML += `<option value="${field}">${field}</option>`;
            });
            
            // Добавляем специальные опции для визуализации
            dataSelect.innerHTML += `
                <option value="none">Без данных (только точки)</option>
                <option value="cluster">Кластеры точек</option>
                <option value="heatmap">Тепловая карта</option>
                <option value="circle">Круговые маркеры</option>
                <option value="symbol">Символьная карта</option>
            `;
        }
        
        function addDataLayer() {
            const latColumn = document.getElementById('latitudeColumn').value;
            const lngColumn = document.getElementById('longitudeColumn').value;
            const dataColumn = document.getElementById('dataColumn').value;
            
            if (!latColumn || !lngColumn) {
                alert('Пожалуйста, выберите столбцы с широтой и долготой');
                return;
            }
            
            // Очищаем предыдущий слой
            markersLayer.clearLayers();
            heatmapLayer.clearLayers();
            if (currentLegend) {
                currentLegend.remove();
                currentLegend = null;
            }
            
            // Собираем данные для визуализации
            const points = [];
            const heatmapData = [];
            const values = [];
            
            currentData.forEach(row => {
                const lat = parseFloat(row[latColumn]);
                const lng = parseFloat(row[lngColumn]);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    points.push([lat, lng]);
                    
                    if (dataColumn && dataColumn !== 'none' && dataColumn !== 'cluster') {
                        const value = parseFloat(row[dataColumn]) || 0;
                        heatmapData.push([lat, lng, value]);
                        values.push(value);
                    }
                }
            });
            
            if (points.length === 0) {
                alert('Не удалось найти корректные координаты в выбранных столбцах');
                return;
            }
            
            // В зависимости от выбранного типа визуализации
            if (dataColumn === 'heatmap') {
                createHeatmapLayer(heatmapData, dataColumn);
            } else if (dataColumn === 'cluster') {
                createClusterLayer(points);
            } else if (dataColumn === 'circle') {
                createCircleMarkersLayer(points, heatmapData, dataColumn);
            } else if (dataColumn === 'symbol') {
                createSymbolLayer(points, heatmapData, dataColumn);
            } else if (dataColumn === 'none') {
                createSimpleMarkersLayer(points);
            } else if (dataColumn && dataColumn !== 'none') {
                createValueMarkersLayer(points, heatmapData, dataColumn);
            }
            
            // Включаем кнопку удаления слоя
            document.getElementById('removeLayerBtn').disabled = false;
        }
        
        function createSimpleMarkersLayer(points) {
            points.forEach(point => {
                const marker = L.marker([point[0], point[1]]).addTo(markersLayer);
                marker.bindPopup(`Широта: ${point[0].toFixed(4)}<br>Долгота: ${point[1].toFixed(4)}`);
            });
            
            currentLayer = markersLayer;
            fitMapToData();
        }
        
        function createClusterLayer(points) {
            const markers = L.markerClusterGroup();
            
            points.forEach(point => {
                const marker = L.marker([point[0], point[1]]);
                marker.bindPopup(`Широта: ${point[0].toFixed(4)}<br>Долгота: ${point[1].toFixed(4)}`);
                markers.addLayer(marker);
            });
            
            markersLayer.addLayer(markers);
            currentLayer = markersLayer;
            fitMapToData();
        }
        
        function createHeatmapLayer(heatmapData, columnName) {
            if (heatmapData.length === 0) return;
            
            const minValue = Math.min(...heatmapData.map(d => d[2]));
            const maxValue = Math.max(...heatmapData.map(d => d[2]));
            
            heatmapData.forEach(point => {
                const value = point[2];
                const normalizedValue = (value - minValue) / (maxValue - minValue);
                const radius = parseInt(document.getElementById('minRadius').value) + 
                              normalizedValue * (parseInt(document.getElementById('maxRadius').value) - parseInt(document.getElementById('minRadius').value));
                const color = getColorForValue(value, minValue, maxValue);
                
                const circle = L.circle([point[0], point[1]], {
                    radius: radius * 100, // Умножаем на 100 для метрической системы
                    fillColor: color,
                    color: color,
                    fillOpacity: 0.7,
                    weight: 1
                }).addTo(heatmapLayer);
                
                circle.bindPopup(`${columnName}: ${value}`);
            });
            
            currentLayer = heatmapLayer;
            fitMapToData();
            
            // Добавляем легенду
            addLegend([minValue, minValue + (maxValue - minValue) / 4, minValue + (maxValue - minValue) / 2, 
                      minValue + (maxValue - minValue) * 3 / 4, maxValue], columnName, 'heat');
        }
        
        function createCircleMarkersLayer(points, values, columnName) {
            if (values.length === 0) return;
            
            const minValue = Math.min(...values.map(d => d[2]));
            const maxValue = Math.max(...values.map(d => d[2]));
            
            values.forEach(point => {
                const value = point[2];
                const normalizedValue = (value - minValue) / (maxValue - minValue);
                const radius = parseInt(document.getElementById('minRadius').value) + 
                              normalizedValue * (parseInt(document.getElementById('maxRadius').value) - parseInt(document.getElementById('minRadius').value));
                const color = getColorForValue(value, minValue, maxValue);
                
                const circle = L.circleMarker([point[0], point[1]], {
                    radius: radius,
                    fillColor: color,
                    color: '#333',
                    weight: 1,
                    fillOpacity: 0.7
                }).addTo(markersLayer);
                
                circle.bindPopup(`${columnName}: ${value}`);
            });
            
            currentLayer = markersLayer;
            fitMapToData();
            
            // Добавляем легенду
            addLegend([minValue, minValue + (maxValue - minValue) / 4, minValue + (maxValue - minValue) / 2, 
                      minValue + (maxValue - minValue) * 3 / 4, maxValue], columnName, 'circle');
        }
        
        function createSymbolLayer(points, values, columnName) {
            if (values.length === 0) return;
            
            const minValue = Math.min(...values.map(d => d[2]));
            const maxValue = Math.max(...values.map(d => d[2]));
            
            values.forEach(point => {
                const value = point[2];
                const normalizedValue = (value - minValue) / (maxValue - minValue);
                const size = parseInt(document.getElementById('minRadius').value) + 
                            normalizedValue * (parseInt(document.getElementById('maxRadius').value) - parseInt(document.getElementById('minRadius').value));
                const color = getColorForValue(value, minValue, maxValue);
                
                // Создаем кастомный символ
                const symbol = L.divIcon({
                    html: `<div style="background-color:${color}; width:${size}px; height:${size}px; border-radius:50%; border:1px solid #333;"></div>`,
                    className: 'symbol-icon',
                    iconSize: [size, size]
                });
                
                const marker = L.marker([point[0], point[1]], {
                    icon: symbol
                }).addTo(markersLayer);
                
                marker.bindPopup(`${columnName}: ${value}`);
            });
            
            currentLayer = markersLayer;
            fitMapToData();
            
            // Добавляем легенду
            addLegend([minValue, minValue + (maxValue - minValue) / 4, minValue + (maxValue - minValue) / 2, 
                      minValue + (maxValue - minValue) * 3 / 4, maxValue], columnName, 'symbol');
        }
        
        function createValueMarkersLayer(points, values, columnName) {
            if (values.length === 0) return;
            
            const minValue = Math.min(...values.map(d => d[2]));
            const maxValue = Math.max(...values.map(d => d[2]));
            
            values.forEach(point => {
                const value = point[2];
                const normalizedValue = (value - minValue) / (maxValue - minValue);
                const size = 5 + normalizedValue * 15;
                const color = getColorForValue(value, minValue, maxValue);
                
                const circle = L.circleMarker([point[0], point[1]], {
                    radius: size,
                    fillColor: color,
                    color: '#333',
                    weight: 1,
                    fillOpacity: 0.7
                }).addTo(markersLayer);
                
                circle.bindPopup(`${columnName}: ${value}`);
            });
            
            currentLayer = markersLayer;
            fitMapToData();
            
            // Добавляем легенду
            addLegend([minValue, minValue + (maxValue - minValue) / 4, minValue + (maxValue - minValue) / 2, 
                      minValue + (maxValue - minValue) * 3 / 4, maxValue], columnName, 'value');
        }
        
        function getColorForValue(value, minValue, maxValue) {
            const colorScheme = document.getElementById('colorScale').value;
            const normalizedValue = (value - minValue) / (maxValue - minValue);
            
            switch(colorScheme) {
                case 'red':
                    return `rgb(${255}, ${Math.round(255 * (1 - normalizedValue))}, ${Math.round(255 * (1 - normalizedValue))})`;
                case 'blue':
                    return `rgb(${Math.round(255 * (1 - normalizedValue))}, ${Math.round(255 * (1 - normalizedValue))}, 255)`;
                case 'green':
                    return `rgb(${Math.round(255 * (1 - normalizedValue))}, 255, ${Math.round(255 * (1 - normalizedValue))})`;
                case 'rainbow':
                    const hue = (1 - normalizedValue) * 240;
                    return `hsl(${hue}, 100%, 50%)`;
                default:
                    return '#3388ff';
            }
        }
        
        function addLegend(grades, title, type) {
            if (currentLegend) {
                currentLegend.remove();
            }
            
            currentLegend = L.control({ position: 'bottomright' });
            
            currentLegend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `<h4>${title}</h4>`;
                
                for (let i = 0; i < grades.length; i++) {
                    const from = grades[i];
                    const to = grades[i + 1];
                    
                    if (type === 'heat' || type === 'circle' || type === 'value') {
                        const color = getColorForValue(from, grades[0], grades[grades.length - 1]);
                        div.innerHTML += `
                            <i style="background:${color}"></i>
                            ${from.toFixed(1)}${to ? `&ndash;${to.toFixed(1)}` : '+'}<br>
                        `;
                    } else if (type === 'symbol') {
                        const size = parseInt(document.getElementById('minRadius').value) + 
                                     (i / (grades.length - 1)) * (parseInt(document.getElementById('maxRadius').value) - parseInt(document.getElementById('minRadius').value));
                        div.innerHTML += `
                            <i style="width:${size}px;height:${size}px;border-radius:50%;background:#3388ff;display:inline-block;vertical-align:middle;"></i>
                            ${from.toFixed(1)}${to ? `&ndash;${to.toFixed(1)}` : '+'}<br>
                        `;
                    }
                }
                
                return div;
            };
            
            currentLegend.addTo(map);
        }
        
        function removeCurrentLayer() {
            if (currentLayer) {
                currentLayer.clearLayers();
                document.getElementById('removeLayerBtn').disabled = true;
                
                if (currentLegend) {
                    currentLegend.remove();
                    currentLegend = null;
                }
            }
        }
        
        function fitMapToData() {
            if (currentLayer && currentLayer.getBounds) {
                map.fitBounds(currentLayer.getBounds());
            }
        }
        
        function clearMap() {
            markersLayer.clearLayers();
            heatmapLayer.clearLayers();
            document.getElementById('removeLayerBtn').disabled = true;
            
            if (currentLegend) {
                currentLegend.remove();
                currentLegend = null;
            }
        }
        
        function exportMapAsImage() {
            // Используем html2canvas для создания изображения карты
            html2canvas(document.querySelector('#map'), {
                useCORS: true,
                allowTaint: true,
                scale: 2,
                logging: false,
                backgroundColor: null
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = currentFileName ? `карта_${currentFileName.split('.')[0]}.png` : 'map.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('Ошибка при экспорте карты:', err);
                alert('Не удалось экспортировать карту как изображение');
            });
        }
        
        function exportDataAsGeoJSON() {
            const latColumn = document.getElementById('latitudeColumn').value;
            const lngColumn = document.getElementById('longitudeColumn').value;
            const dataColumn = document.getElementById('dataColumn').value;
            
            if (!latColumn || !lngColumn) {
                alert('Пожалуйста, выберите столбцы с широтой и долготой');
                return;
            }
            
            // Создаем GeoJSON объект
            const geojson = {
                type: 'FeatureCollection',
                features: []
            };
            
            currentData.forEach(row => {
                const lat = parseFloat(row[latColumn]);
                const lng = parseFloat(row[lngColumn]);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const feature = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [lng, lat]
                        },
                        properties: {}
                    };
                    
                    // Добавляем все свойства из данных
                    Object.keys(row).forEach(key => {
                        if (key !== latColumn && key !== lngColumn) {
                            feature.properties[key] = row[key];
                        }
                    });
                    
                    geojson.features.push(feature);
                }
            });
            
            // Создаем ссылку для скачивания
            const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(geojson, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute('href', dataStr);
            downloadAnchorNode.setAttribute('download', currentFileName ? `${currentFileName.split('.')[0]}.geojson` : 'data.geojson');
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        function exportMapAsPDF() {
            // Используем html2canvas и jsPDF для создания PDF
            html2canvas(document.querySelector('#map'), {
                useCORS: true,
                allowTaint: true,
                scale: 2,
                logging: false,
                backgroundColor: null
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('landscape');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(currentFileName ? `карта_${currentFileName.split('.')[0]}.pdf` : 'map.pdf');
            }).catch(err => {
                console.error('Ошибка при экспорте PDF:', err);
                alert('Не удалось экспортировать карту как PDF');
            });
        }
    </script>
</body>
</html>