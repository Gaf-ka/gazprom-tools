<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–æ–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ - –ì–∞–∑–ø—Ä–æ–º</title>
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .map-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .map-box {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            position: relative;
        }
        
        .map-box h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .map-wrapper {
            position: relative;
            height: 600px;
            width: 100%;
            margin-bottom: 1rem;
            z-index: 1;
        }
        
        #map {
            height: 100%;
            width: 100%;
            border-radius: 4px;
        }
        
        .map-controls {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .map-controls button, .map-controls select, .map-controls input {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .map-controls button:hover {
            background-color: var(--secondary-color);
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        .settings-panel {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        
        .settings-group {
            margin-bottom: 1rem;
        }
        
        .settings-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .color-picker input {
            width: 40px;
            height: 30px;
            padding: 0;
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .form-group {
            flex: 1;
        }
        
        .download-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .file-info {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .legend {
            padding: 6px 8px;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 1.5;
        }
        
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        
        .data-table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        
        .map-layer-control {
            background: white;
            padding: 5px;
            border-radius: 4px;
        }
        
        .column-options {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-container">
                <div class="logo">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Gazprom_logo.svg/1200px-Gazprom_logo.svg.png" alt="–ì–∞–∑–ø—Ä–æ–º" class="logo-img">
                    <div class="logo-text">
                        <span class="logo-title">–ì–∞–∑–ø—Ä–æ–º</span>
                        <span class="logo-subtitle">–ì–µ–æ–∞–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                    </div>
                </div>
                
                <nav class="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item"><a href="../index.html" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li class="nav-item"><a href="../office-tools/index.html" class="nav-link">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</a></li>
                        <li class="nav-item"><a href="../trainers/index.html" class="nav-link">–¢—Ä–µ–Ω–∞–∂—ë—Ä—ã</a></li>
                        <li class="nav-item"><a href="index.html" class="nav-link">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a></li>
                        <li class="nav-item"><a href="../ai-assistant/index.html" class="nav-link">–ü–æ–º–æ—â–Ω–∏–∫</a></li>
                    </ul>
                </nav>
                
                <button class="mobile-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main class="main">
        <section class="section-header">
            <div class="container">
                <h1 class="section-title">–ì–µ–æ–∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
                <p class="section-subtitle">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–∞—Ä—Ç–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p>
            </div>
        </section>

        <div class="container">
            <div class="map-container">
                <div class="map-box">
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä—Ç—ã</h3>
                    
                    <div class="upload-area" id="uploadArea">
                        <p><i class="fas fa-cloud-upload-alt"></i> –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ CSV –∏–ª–∏ Excel —Ñ–∞–π–ª —Å –≥–µ–æ–¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏</p>
                        <button class="btn btn-outline" id="selectFileBtn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                        <div class="file-info" id="fileInfo">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                        <p class="file-hint">–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–æ–ª–±—Ü—ã —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ (—à–∏—Ä–æ—Ç–∞ –∏ –¥–æ–ª–≥–æ—Ç–∞) –∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏</p>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="latitudeColumn">–°—Ç–æ–ª–±–µ—Ü —Å —à–∏—Ä–æ—Ç–æ–π:</label>
                            <select id="latitudeColumn" disabled>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="longitudeColumn">–°—Ç–æ–ª–±–µ—Ü —Å –¥–æ–ª–≥–æ—Ç–æ–π:</label>
                            <select id="longitudeColumn" disabled>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataColumn">–°—Ç–æ–ª–±–µ—Ü —Å –¥–∞–Ω–Ω—ã–º–∏:</label>
                            <select id="dataColumn" disabled>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü</option>
                                <option value="none">–ë–µ–∑ –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∏)</option>
                                <option value="cluster">–ö–ª–∞—Å—Ç–µ—Ä—ã —Ç–æ—á–µ–∫</option>
                                <option value="heatmap">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
                                <option value="circle">–ö—Ä—É–≥–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="columnOptions" class="column-options">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="markerColor">–¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–æ–≤:</label>
                                <input type="color" id="markerColor" value="#3388ff">
                            </div>
                            <div class="form-group">
                                <label for="markerSize">–†–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–æ–≤:</label>
                                <input type="range" id="markerSize" min="5" max="30" value="10">
                            </div>
                        </div>
                    </div>
                    
                    <div class="map-wrapper">
                        <div id="map"></div>
                    </div>
                    
                    <div class="map-controls">
                        <button id="addLayerBtn"><i class="fas fa-layer-group"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–π</button>
                        <button id="removeLayerBtn" disabled><i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å —Å–ª–æ–π</button>
                        <button id="fitBoundsBtn"><i class="fas fa-expand"></i> –ü–æ–¥–æ–≥–Ω–∞—Ç—å –æ–±–ª–∞—Å—Ç—å</button>
                        <button id="clearMapBtn"><i class="fas fa-broom"></i> –û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                    </div>
                    
                    <div class="download-buttons">
                        <button id="exportImageBtn"><i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                        <button id="exportDataBtn"><i class="fas fa-file-csv"></i> –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (GeoJSON)</button>
                        <button id="exportPdfBtn"><i class="fas fa-file-pdf"></i> –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç (PDF)</button>
                    </div>
                    
                    <div class="settings-panel">
                        <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mapStyle">–°—Ç–∏–ª—å –∫–∞—Ä—Ç—ã:</label>
                                <select id="mapStyle">
                                    <option value="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png">OpenStreetMap</option>
                                    <option value="https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png">OpenTopoMap</option>
                                    <option value="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}">–°–ø—É—Ç–Ω–∏–∫</option>
                                    <option value="https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png">–¢–µ–º–Ω–∞—è</option>
                                    <option value="https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png">–°–≤–µ—Ç–ª–∞—è</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mapZoom">–£—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
                                <input type="range" id="mapZoom" min="1" max="18" value="5">
                            </div>
                        </div>
                    </div>
                    
                    <h3>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                    <div class="data-table-container">
                        <table class="data-table" id="dataTable">
                            <thead id="headerRow"></thead>
                            <tbody id="tableData"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-container">
                <div class="footer-column">
                    <h4 class="footer-title">–ì–∞–∑–ø—Ä–æ–º</h4>
                    <p class="footer-text">–ö—Ä—É–ø–Ω–µ–π—à–∞—è –≥–∞–∑–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è –º–∏—Ä–∞, –ª–∏–¥–µ—Ä –≤ –æ–±–ª–∞—Å—Ç–∏ —Ä–∞–∑–≤–µ–¥–∫–∏, –¥–æ–±—ã—á–∏, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, —Ö—Ä–∞–Ω–µ–Ω–∏—è, –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É–≥–ª–µ–≤–æ–¥–æ—Ä–æ–¥–æ–≤.</p>
                </div>
                
                <div class="footer-column">
                    <h4 class="footer-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</h4>
                    <ul class="footer-links">
                        <li><a href="../index.html" class="footer-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li><a href="../office-tools/index.html" class="footer-link">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</a></li>
                        <li><a href="../trainers/index.html" class="footer-link">–¢—Ä–µ–Ω–∞–∂—ë—Ä—ã</a></li>
                        <li><a href="index.html" class="footer-link">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h4 class="footer-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                    <ul class="footer-contacts">
                        <li class="contact-item">
                            <span class="contact-icon">üìû</span>
                            <span>+7 (495) 719-30-01</span>
                        </li>
                        <li class="contact-item">
                            <span class="contact-icon">‚úâÔ∏è</span>
                            <span>portal@gazprom.ru</span>
                        </li>
                        <li class="contact-item">
                            <span class="contact-icon">üìç</span>
                            <span>–ú–æ—Å–∫–≤–∞, —É–ª. –ù–∞–º–µ—Ç–∫–∏–Ω–∞, 16</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>¬© 2025 –ü–ê–û "–ì–∞–∑–ø—Ä–æ–º". –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
                <div class="footer-links">
                    <a href="#" class="footer-link">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                    <a href="#" class="footer-link">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let map;
        let currentLayer = null;
        let markersLayer = null;
        let heatmapLayer = null;
        let currentData = [];
        let currentFileName = '';
        let layersControl = null;
        let baseLayers = {};
        let overlayLayers = {};
        let legend = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
        });
        
        function initializeMap() {
            map = L.map('map').setView([55.751244, 37.618423], 5); // –¶–µ–Ω—Ç—Ä –Ω–∞ –ú–æ—Å–∫–≤–µ
            
            // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π —Å–ª–æ–π
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            baseLayers = {
                "OpenStreetMap": osmLayer,
                "OpenTopoMap": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    maxZoom: 17,
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
                }),
                "–°–ø—É—Ç–Ω–∏–∫": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                }),
                "–¢–µ–º–Ω–∞—è": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }),
                "–°–≤–µ—Ç–ª–∞—è": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                })
            };
            
            layersControl = L.control.layers(baseLayers, overlayLayers, {
                collapsed: false,
                position: 'topright'
            }).addTo(map);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å—à—Ç–∞–±
            L.control.scale({position: 'bottomleft'}).addTo(map);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ–π –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
            markersLayer = L.layerGroup().addTo(map);
            overlayLayers['–ú–∞—Ä–∫–µ—Ä—ã'] = markersLayer;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ–π –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
            heatmapLayer = L.layerGroup().addTo(map);
            overlayLayers['–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞'] = heatmapLayer;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–ª–æ–µ–≤
            layersControl.addOverlay(markersLayer, '–ú–∞—Ä–∫–µ—Ä—ã');
            layersControl.addOverlay(heatmapLayer, '–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞');
        }
        
        function setupEventListeners() {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const selectFileBtn = document.getElementById('selectFileBtn');
            
            selectFileBtn.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary-color)';
                uploadArea.style.backgroundColor = 'var(--primary-light)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.backgroundColor = 'transparent';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.backgroundColor = 'transparent';
                
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    handleFileUpload(fileInput.files[0]);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('addLayerBtn').addEventListener('click', addDataLayer);
            document.getElementById('removeLayerBtn').addEventListener('click', removeCurrentLayer);
            document.getElementById('fitBoundsBtn').addEventListener('click', fitMapToData);
            document.getElementById('clearMapBtn').addEventListener('click', clearMap);
            document.getElementById('exportImageBtn').addEventListener('click', exportMapAsImage);
            document.getElementById('exportDataBtn').addEventListener('click', exportDataAsGeoJSON);
            document.getElementById('exportPdfBtn').addEventListener('click', exportMapAsPDF);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('mapStyle').addEventListener('change', function() {
                const selectedStyle = this.value;
                Object.values(baseLayers).forEach(layer => map.removeLayer(layer));
                baseLayers[this.options[this.selectedIndex].text].addTo(map);
            });
            
            document.getElementById('mapZoom').addEventListener('input', function() {
                map.setZoom(parseInt(this.value));
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
            map.on('zoomend', function() {
                document.getElementById('mapZoom').value = map.getZoom();
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            document.getElementById('dataColumn').addEventListener('change', function() {
                const optionsPanel = document.getElementById('columnOptions');
                if (this.value && this.value !== 'none') {
                    optionsPanel.style.display = 'block';
                } else {
                    optionsPanel.style.display = 'none';
                }
            });
        }
        
        function handleFileUpload(file) {
            currentFileName = file.name;
            document.getElementById('fileInfo').textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ${file.name}`;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = e.target.result;
                
                if (file.name.endsWith('.csv')) {
                    parseCSV(data);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    parseExcel(data);
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        function parseCSV(data) {
            Papa.parse(data, {
                header: true,
                complete: function(results) {
                    if (results.data.length > 0 && results.meta.fields) {
                        processParsedData(results.meta.fields, results.data);
                    } else {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.');
                    }
                },
                error: function(error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ CSV —Ñ–∞–π–ª–∞: ' + error.message);
                }
            });
        }
        
        function parseExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (jsonData.length > 1) {
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç, –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π CSV
                    const fields = headers;
                    const data = rows.map(row => {
                        const obj = {};
                        headers.forEach((header, i) => {
                            obj[header] = row[i] !== undefined ? row[i] : '';
                        });
                        return obj;
                    });
                    
                    processParsedData(fields, data);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: ' + error.message);
            }
        }
        
        function processParsedData(fields, data) {
            currentData = data;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –¥–∞–Ω–Ω—ã–º–∏
            updateDataTable(fields, data);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
            updateColumnSelects(fields);
            
            // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('latitudeColumn').disabled = false;
            document.getElementById('longitudeColumn').disabled = false;
            document.getElementById('dataColumn').disabled = false;
        }
        
        function updateDataTable(fields, data) {
            const headerRow = document.getElementById('headerRow');
            const tableData = document.getElementById('tableData');
            
            // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            headerRow.innerHTML = '';
            tableData.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            fields.forEach(field => {
                headerRow.innerHTML += `<th>${field}</th>`;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–µ 50 —Å—Ç—Ä–æ–∫)
            const displayData = data.slice(0, 50);
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                fields.forEach(field => {
                    const value = row[field] !== undefined ? row[field] : '';
                    tr.innerHTML += `<td>${value}</td>`;
                });
                tableData.appendChild(tr);
            });
            
            if (data.length > 50) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="${fields.length}" style="text-align: center; font-style: italic;">... –∏ –µ—â–µ ${data.length - 50} —Å—Ç—Ä–æ–∫</td>`;
                tableData.appendChild(tr);
            }
        }
        
        function updateColumnSelects(fields) {
            const latitudeSelect = document.getElementById('latitudeColumn');
            const longitudeSelect = document.getElementById('longitudeColumn');
            const dataSelect = document.getElementById('dataColumn');
            
            // –û—á–∏—â–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
            latitudeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü</option>';
            longitudeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü</option>';
            dataSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü</option>';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è
            fields.forEach(field => {
                latitudeSelect.innerHTML += `<option value="${field}">${field}</option>`;
                longitudeSelect.innerHTML += `<option value="${field}">${field}</option>`;
                dataSelect.innerHTML += `<option value="${field}">${field}</option>`;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            dataSelect.innerHTML += `
                <option value="none">–ë–µ–∑ –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∏)</option>
                <option value="cluster">–ö–ª–∞—Å—Ç–µ—Ä—ã —Ç–æ—á–µ–∫</option>
                <option value="heatmap">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
                <option value="circle">–ö—Ä—É–≥–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã</option>
            `;
        }
        
        function addDataLayer() {
            const latColumn = document.getElementById('latitudeColumn').value;
            const lngColumn = document.getElementById('longitudeColumn').value;
            const dataColumn = document.getElementById('dataColumn').value;
            
            if (!latColumn || !lngColumn) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±—Ü—ã —Å —à–∏—Ä–æ—Ç–æ–π –∏ –¥–æ–ª–≥–æ—Ç–æ–π');
                return;
            }
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–æ–π
            markersLayer.clearLayers();
            heatmapLayer.clearLayers();
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ª–µ–≥–µ–Ω–¥—É
            if (legend) {
                legend.remove();
                legend = null;
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            const points = [];
            const heatmapData = [];
            
            currentData.forEach(row => {
                const lat = parseFloat(row[latColumn]);
                const lng = parseFloat(row[lngColumn]);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    points.push([lat, lng]);
                    
                    if (dataColumn && dataColumn !== 'none' && dataColumn !== 'cluster') {
                        const value = parseFloat(row[dataColumn]) || 0;
                        heatmapData.push([lat, lng, value]);
                    }
                }
            });
            
            if (points.length === 0) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–∞—Ö');
                return;
            }
            
            // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            if (dataColumn === 'heatmap') {
                createHeatmapLayer(heatmapData, dataColumn);
            } else if (dataColumn === 'cluster') {
                createClusterLayer(points);
            } else if (dataColumn === 'circle') {
                createCircleMarkersLayer(points, heatmapData, dataColumn);
            } else if (dataColumn === 'none') {
                createSimpleMarkersLayer(points);
            } else if (dataColumn && dataColumn !== 'none') {
                createValueMarkersLayer(points, heatmapData, dataColumn);
            }
            
            // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ—è
            document.getElementById('removeLayerBtn').disabled = false;
        }
        
        function createSimpleMarkersLayer(points) {
            const markerColor = document.getElementById('markerColor').value;
            const markerSize = parseInt(document.getElementById('markerSize').value);
            
            points.forEach(point => {
                const marker = L.circleMarker([point[0], point[1]], {
                    radius: markerSize,
                    fillColor: markerColor,
                    color: '#333',
                    weight: 1,
                    fillOpacity: 0.8
                }).addTo(markersLayer);
                
                marker.bindPopup(`–®–∏—Ä–æ—Ç–∞: ${point[0].toFixed(4)}<br>–î–æ–ª–≥–æ—Ç–∞: ${point[1].toFixed(4)}`);
            });
            
            currentLayer = markersLayer;
            fitMapToData();
        }
        
        function createClusterLayer(points) {
            const markerColor = document.getElementById('markerColor').value;
            const markers = L.markerClusterGroup();
            
            points.forEach(point => {
                const marker = L.circleMarker([point[0], point[1]], {
                    radius: 8,
                    fillColor: markerColor,
                    color: '#333',
                    weight: 1,
                    fillOpacity: 0.8
                });
                marker.bindPopup(`–®–∏—Ä–æ—Ç–∞: ${point[0].toFixed(4)}<br>–î–æ–ª–≥–æ—Ç–∞: ${point[1].toFixed(4)}`);
                markers.addLayer(marker);
            });
            
            markersLayer.addLayer(markers);
            currentLayer = markersLayer;
            fitMapToData();
        }
        
        function createHeatmapLayer(heatmapData, columnName) {
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä—É–≥–∏ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º —Ü–≤–µ—Ç–∞
            const minValue = Math.min(...heatmapData.map(p => p[2]));
            const maxValue = Math.max(...heatmapData.map(p => p[2]));
            
            heatmapData.forEach(point => {
                const normalizedValue = (point[2] - minValue) / (maxValue - minValue);
                const radius = 5 + normalizedValue * 25; // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ä–∞–¥–∏—É—Å–∞
                const color = getColorForValue(point[2], minValue, maxValue);
                
                const circle = L.circle([point[0], point[1]], {
                    radius: radius * 1000, // –í –º–µ—Ç—Ä–∞—Ö
                    fillColor: color,
                    color: color,
                    fillOpacity: 0.5
                }).addTo(heatmapLayer);
                
                circle.bindPopup(`–ó–Ω–∞—á–µ–Ω–∏–µ: ${point[2]}`);
            });
            
            currentLayer = heatmapLayer;
            fitMapToData();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
            addLegend([minValue, minValue + (maxValue - minValue) / 4, minValue + (maxValue - minValue) / 2, 
                     minValue + (maxValue - minValue) * 3 / 4, maxValue], columnName, 'heat');
        }
        
        function createCircleMarkersLayer(points, values, columnName) {
            const minValue = Math.min(...values.map(p => p[2]));
            const maxValue = Math.max(...values.map(p => p[2]));
            
            values.forEach(point => {
                const normalizedValue = (point[2] - minValue) / (maxValue - minValue);
                const radius = 5 + normalizedValue * 15;
                const color = getColorForValue(point[2], minValue, maxValue);
                
                const circle = L.circle([point[0], point[1]], {
                    radius: radius * 1000, // –í –º–µ—Ç—Ä–∞—Ö
                    fillColor: color,
                    color: color,
                    fillOpacity: 0.5
                }).addTo(markersLayer);
                
                circle.bindPopup(`–ó–Ω–∞—á–µ–Ω–∏–µ: ${point[2]}`);
            });
            
            currentLayer = markersLayer;
            fitMapToData();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
            addLegend([minValue, minValue + (maxValue - minValue) / 4, minValue + (maxValue - minValue) / 2, 
                     minValue + (maxValue - minValue) * 3 / 4, maxValue], columnName, 'circle');
        }
        
        function createValueMarkersLayer(points, values, columnName) {
            const minValue = Math.min(...values.map(p => p[2]));
            const maxValue = Math.max(...values.map(p => p[2]));
            
            values.forEach(point => {
                const value = point[2];
                const normalizedValue = (value - minValue) / (maxValue - minValue);
                const radius = 5 + normalizedValue * 15;
                const color = getColorForValue(value, minValue, maxValue);
                
                const circle = L.circleMarker([point[0], point[1]], {
                    radius: radius,
                    fillColor: color,
                    color: '#333',
                    weight: 1,
                    fillOpacity: 0.8
                }).addTo(markersLayer);
                
                circle.bindPopup(`${columnName}: ${value}`);
            });
            
            currentLayer = markersLayer;
            fitMapToData();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
            addLegend([minValue, minValue + (maxValue - minValue) / 4, minValue + (maxValue - minValue) / 2, 
                     minValue + (maxValue - minValue) * 3 / 4, maxValue], columnName, 'value');
        }
        
        function getColorForValue(value, minValue, maxValue) {
            // –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Å–∏–Ω–µ–≥–æ –∫ –∫—Ä–∞—Å–Ω–æ–º—É
            const normalizedValue = (value - minValue) / (maxValue - minValue);
            const hue = ((1 - normalizedValue) * 240).toString(10);
            return `hsl(${hue}, 100%, 50%)`;
        }
        
        function addLegend(grades, title, type) {
            legend = L.control({ position: 'bottomright' });
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `<h4>${title}</h4>`;
                
                for (let i = 0; i < grades.length; i++) {
                    const from = grades[i];
                    const to = grades[i + 1];
                    
                    if (type === 'heat' || type === 'circle') {
                        const color = getColorForValue(from, grades[0], grades[grades.length-1]);
                        div.innerHTML += `
                            <i style="background:${color}"></i>
                            ${from.toFixed(2)}${to ? `&ndash;${to.toFixed(2)}` : '+'}<br>
                        `;
                    } else if (type === 'value') {
                        const size = 5 + (i / (grades.length - 1)) * 15;
                        div.innerHTML += `
                            <i style="width:${size * 2}px;height:${size * 2}px;border-radius:${size}px;background:#3388ff;display:inline-block;vertical-align:middle;"></i>
                            ${from.toFixed(2)}${to ? `&ndash;${to.toFixed(2)}` : '+'}<br>
                        `;
                    }
                }
                
                return div;
            };
            
            legend.addTo(map);
        }
        
        function removeCurrentLayer() {
            if (currentLayer) {
                currentLayer.clearLayers();
                document.getElementById('removeLayerBtn').disabled = true;
                
                if (legend) {
                    legend.remove();
                    legend = null;
                }
            }
        }
        
        function fitMapToData() {
            if (currentLayer && currentLayer.getBounds) {
                map.fitBounds(currentLayer.getBounds());
            }
        }
        
        function clearMap() {
            markersLayer.clearLayers();
            heatmapLayer.clearLayers();
            document.getElementById('removeLayerBtn').disabled = true;
            
            if (legend) {
                legend.remove();
                legend = null;
            }
        }
        
        function exportMapAsImage() {
            const mapElement = document.getElementById('map');
            
            html2canvas(mapElement, {
                useCORS: true,
                allowTaint: true,
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = currentFileName ? `–∫–∞—Ä—Ç–∞_${currentFileName.split('.')[0]}.png` : 'map.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        function exportDataAsGeoJSON() {
            const latColumn = document.getElementById('latitudeColumn').value;
            const lngColumn = document.getElementById('longitudeColumn').value;
            const dataColumn = document.getElementById('dataColumn').value;
            
            if (!latColumn || !lngColumn) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±—Ü—ã —Å —à–∏—Ä–æ—Ç–æ–π –∏ –¥–æ–ª–≥–æ—Ç–æ–π');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º GeoJSON –æ–±—ä–µ–∫—Ç
            const geojson = {
                type: 'FeatureCollection',
                features: []
            };
            
            currentData.forEach(row => {
                const lat = parseFloat(row[latColumn]);
                const lng = parseFloat(row[lngColumn]);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const feature = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [lng, lat]
                        },
                        properties: {}
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
                    Object.keys(row).forEach(key => {
                        if (key !== latColumn && key !== lngColumn) {
                            feature.properties[key] = row[key];
                        }
                    });
                    
                    geojson.features.push(feature);
                }
            });
            
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(geojson, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute('href', dataStr);
            downloadAnchorNode.setAttribute('download', currentFileName ? `${currentFileName.split('.')[0]}.geojson` : 'data.geojson');
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        function exportMapAsPDF() {
            const { jsPDF } = window.jspdf;
            const mapElement = document.getElementById('map');
            
            html2canvas(mapElement, {
                useCORS: true,
                allowTaint: true,
                scale: 2
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('landscape');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(currentFileName ? `–∫–∞—Ä—Ç–∞_${currentFileName.split('.')[0]}.pdf` : 'map.pdf');
            });
        }
    </script>
</body>
</html>