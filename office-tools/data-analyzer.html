<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор данных - Газпром</title>
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <main class="main">
        <section class="section-header">
            <div class="container">
                <h1 class="section-title">Анализатор данных</h1>
                <p class="section-subtitle">Загрузите файл Excel для анализа</p>
            </div>
        </section>

        <section class="data-analyzer">
            <div class="container">
                <div class="file-upload-container">
                    <input type="file" id="file-input" accept=".xlsx, .xls, .csv">
                    <label for="file-input" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Загрузить файл
                    </label>
                    <span id="file-name">Файл не выбран</span>
                </div>

                <div class="analyzer-grid">
                    <div class="data-table-container">
                        <div class="table-scroll">
                            <table id="data-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="data-results">
                        <h3>Результаты анализа</h3>
                        <div class="chart-container">
                            <canvas id="analysis-chart"></canvas>
                        </div>
                        <div class="stats-container" id="stats-container"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        let currentData = [];
        let chart = null;

        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('file-name').textContent = file.name;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                currentData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                renderTable(currentData);
                analyzeData(currentData);
            };
            
            reader.readAsArrayBuffer(file);
        });

        function renderTable(data) {
            const table = document.getElementById('data-table');
            table.innerHTML = '';
            
            if (data.length === 0) return;
            
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            // Header
            const headerRow = document.createElement('tr');
            data[0].forEach(cell => {
                const th = document.createElement('th');
                th.textContent = cell;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Body
            for (let i = 1; i < data.length; i++) {
                const row = document.createElement('tr');
                data[i].forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            }
        }

        function analyzeData(data) {
            if (data.length < 2) return;
            
            const statsContainer = document.getElementById('stats-container');
            statsContainer.innerHTML = '';
            
            const headers = data[0];
            const numericColumns = [];
            
            // Identify numeric columns
            for (let col = 0; col < headers.length; col++) {
                if (!isNaN(parseFloat(data[1][col]))) {
                    numericColumns.push(col);
                    
                    const values = [];
                    for (let row = 1; row < data.length; row++) {
                        if (data[row][col]) {
                            values.push(parseFloat(data[row][col]));
                        }
                    }
                    
                    if (values.length > 0) {
                        const sum = values.reduce((a, b) => a + b, 0);
                        const avg = sum / values.length;
                        const min = Math.min(...values);
                        const max = Math.max(...values);
                        
                        const statCard = document.createElement('div');
                        statCard.className = 'stat-card';
                        statCard.innerHTML = `
                            <h4>${headers[col]}</h4>
                            <p>Среднее: ${avg.toFixed(2)}</p>
                            <p>Мин/Макс: ${min.toFixed(2)} / ${max.toFixed(2)}</p>
                            <p>Всего: ${sum.toFixed(2)}</p>
                        `;
                        statsContainer.appendChild(statCard);
                    }
                }
            }
            
            updateChart(data, numericColumns);
        }

        function updateChart(data, numericColumns) {
            const ctx = document.getElementById('analysis-chart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            if (numericColumns.length === 0) return;
            
            const headers = data[0];
            const labels = [];
            const datasets = [];
            
            // Use first column as labels
            for (let i = 1; i < data.length; i++) {
                if (data[i][0]) {
                    labels.push(data[i][0]);
                }
            }
            
            // Create datasets for numeric columns
            numericColumns.forEach((col, idx) => {
                const values = [];
                for (let i = 1; i < data.length; i++) {
                    if (data[i][col]) {
                        values.push(parseFloat(data[i][col]));
                    }
                }
                
                datasets.push({
                    label: headers[col],
                    data: values,
                    backgroundColor: getColor(idx),
                    borderColor: getColor(idx),
                    borderWidth: 1
                });
            });
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function getColor(index) {
            const colors = [
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 99, 132, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ];
            return colors[index % colors.length];
        }
    </script>
</body>
</html>